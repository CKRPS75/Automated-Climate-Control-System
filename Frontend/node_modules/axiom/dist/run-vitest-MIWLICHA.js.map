{"version":3,"sources":["../src/evals/run-vitest.ts"],"sourcesContent":["import c from 'tinyrainbow';\nimport { resolve, join } from 'node:path';\nimport { mkdirSync, writeFileSync, unlinkSync, existsSync, readFileSync } from 'node:fs';\nimport { tmpdir } from 'node:os';\nimport path from 'node:path';\nimport tsconfigPaths from 'vite-tsconfig-paths';\n\nimport { createVitest, registerConsoleShortcuts } from 'vitest/node';\nimport type { TestRunResult } from 'vitest/node';\nimport { AxiomReporter } from './reporter';\nimport { flush, initInstrumentation } from './instrument';\nimport { setAxiomConfig } from './context/storage';\nimport type { ResolvedAxiomConfig } from '../config/index';\n\nconst printCollectedEvals = (result: TestRunResult, rootDir: string) => {\n  if (!result.testModules || result.testModules.length === 0) {\n    console.log(c.yellow('\\nNo evaluations found\\n'));\n    return;\n  }\n\n  console.log(c.bold('\\nFound evaluations:\\n'));\n\n  let totalEvals = 0;\n  let totalCases = 0;\n\n  for (const module of result.testModules) {\n    const relativePath = path.relative(rootDir, module.moduleId);\n\n    for (const suite of module.children.suites()) {\n      totalEvals++;\n      const caseCount = suite.children.size;\n      totalCases += caseCount;\n      console.log(c.green(`âœ“ ${suite.name} (${caseCount} cases)`));\n      console.log(c.dim(`  ${relativePath}`));\n      console.log('');\n    }\n  }\n\n  console.log(c.bold(`Total: ${totalEvals} evaluations, ${totalCases} test cases\\n`));\n};\n\nexport const runVitest = async (\n  dir: string,\n  opts: {\n    watch: boolean;\n    baseline?: string;\n    include: string[];\n    exclude?: string[];\n    testNamePattern?: RegExp;\n    debug?: boolean;\n    list?: boolean;\n    overrides?: Record<string, any>;\n    config: ResolvedAxiomConfig;\n    runId: string;\n    consoleUrl?: string;\n  },\n) => {\n  // Store config globally so reporters can access it\n  setAxiomConfig(opts.config);\n  // Initialize instrumentation explicitly based on debug or list flag\n  await initInstrumentation({\n    enabled: !opts.debug && !opts.list,\n    config: opts.config,\n  });\n\n  const providedConfig: ResolvedAxiomConfig = {\n    ...opts.config,\n    eval: {\n      ...opts.config.eval,\n      // These can't be serialized, so we need to remove them\n      instrumentation: null,\n      flagSchema: null,\n    },\n  };\n\n  if (opts.debug) {\n    console.log(c.bgWhite(c.blackBright(' Debug mode enabled ')));\n  }\n\n  // Setup temp files for cross-worker name validation\n  const tmpDir = join(tmpdir(), 'axiom-eval', opts.runId);\n  mkdirSync(tmpDir, { recursive: true });\n\n  const nameRegistryFile = join(tmpDir, 'names.jsonl');\n  const abortFile = join(tmpDir, 'abort.txt');\n\n  // Clear registry file and remove any stale abort file\n  writeFileSync(nameRegistryFile, '', 'utf8');\n  if (existsSync(abortFile)) {\n    unlinkSync(abortFile);\n  }\n\n  // Make paths available to workers and reporters\n  process.env.AXIOM_NAME_REGISTRY_FILE = nameRegistryFile;\n  process.env.AXIOM_ABORT_FILE = abortFile;\n\n  if (opts.list) {\n    console.log(c.bgWhite(c.blackBright(' List mode ')));\n  }\n\n  const vi = await createVitest(\n    'test',\n    {\n      root: dir ? dir : process.cwd(),\n      mode: 'test',\n      include: opts.include,\n      exclude: opts.exclude,\n      testNamePattern: opts.testNamePattern,\n      reporters: ['verbose', new AxiomReporter()],\n      environment: 'node',\n      browser: undefined,\n      watch: opts.watch,\n      setupFiles: [], // ignore user vitest.config.ts etc\n      name: 'axiom:eval',\n      printConsoleTrace: true,\n      silent: false,\n      disableConsoleIntercept: true,\n      testTimeout: opts.config?.eval?.timeoutMs || 60_000,\n      globals: true,\n      runner: resolve(__dirname, 'evals', 'custom-runner.js'),\n      provide: {\n        baseline: opts.baseline,\n        debug: opts.debug,\n        list: opts.list,\n        overrides: opts.overrides,\n        axiomConfig: providedConfig,\n        runId: opts.runId,\n        consoleUrl: opts.consoleUrl,\n      },\n    },\n    {\n      plugins: [tsconfigPaths({ root: dir || process.cwd() })],\n    },\n  );\n\n  // List mode: just list tests without running them\n  if (opts.list) {\n    const result = await vi.collect();\n    printCollectedEvals(result, dir || process.cwd());\n    await vi.close();\n    process.exit(0);\n  }\n\n  // Start collection and execution\n  await vi.start();\n\n  // After execution, check if validation failed\n  if (existsSync(abortFile)) {\n    const message = readFileSync(abortFile, 'utf8');\n    console.error('\\n' + message);\n    await vi.close();\n    process.exit(1);\n  }\n\n  const dispose = registerConsoleShortcuts(vi, process.stdin, process.stdout);\n\n  if (!vi.shouldKeepServer()) {\n    dispose();\n    await flush();\n    await vi.close();\n    process.exit(0);\n  }\n\n  await flush();\n};\n"],"mappings":"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","names":[]}