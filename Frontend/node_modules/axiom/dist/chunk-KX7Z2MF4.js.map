{"version":3,"sources":["../src/cli/auth/global-auth.ts","../src/cli/auth/config.ts","../src/config/index.ts","../src/cli/auth/index.ts","../src/cli/auth/types.ts","../src/cli/auth/oauth.ts","../src/cli/auth/api.ts","../src/cli/auth/callback-server.ts"],"sourcesContent":["import { loadGlobalConfig, getActiveProfile } from './config';\n\nexport interface AuthContext {\n  readonly token: string;\n  readonly url: string;\n  readonly orgId: string;\n}\n\n/**\n * Module-level store for auth context.\n * This provides explicit, type-safe access to auth credentials.\n */\nlet authContext: AuthContext | null = null;\n\n/**\n * Gets the current auth context.\n * Returns null if auth hasn't been set up yet.\n */\nexport function getAuthContext(): AuthContext | null {\n  return authContext;\n}\n\n/**\n * Sets up authentication context by loading config and storing it.\n *\n * @throws {AxiomCLIError} If no active profile is found\n */\nexport async function setupGlobalAuth(): Promise<AuthContext | null> {\n  const config = await loadGlobalConfig();\n  const profile = getActiveProfile(config);\n  if (profile) {\n    // Store in module-level context for explicit access\n    authContext = {\n      token: profile.token,\n      url: profile.url,\n      orgId: profile.org_id,\n    };\n  }\n\n  return authContext;\n}\n\n/**\n * Resets the auth context (useful for testing).\n */\nexport function resetAuthContext(): void {\n  authContext = null;\n}\n","import { promises as fs } from 'fs';\nimport path from 'path';\nimport os from 'os';\nimport type { Config, Profile } from './types';\n\nconst CONFIG_FILENAME = 'config.json';\nconst CONFIG_DIR_NAME = 'axiom';\n\n/**\n * Gets the OS-appropriate config directory path.\n * - Linux/Unix: ~/.config/axiom\n * - macOS: ~/Library/Application Support/axiom\n * - Windows: %APPDATA%\\axiom\n */\nexport function getConfigDir(): string {\n  const platform = process.platform;\n  const homeDir = os.homedir();\n\n  // Linux/Unix: ~/.config/axiom (or $XDG_CONFIG_HOME/axiom if set)\n  const xdgConfigHome = process.env.XDG_CONFIG_HOME;\n  if (xdgConfigHome) {\n    return path.join(xdgConfigHome, CONFIG_DIR_NAME);\n  }\n\n  if (platform === 'win32') {\n    // Windows: %APPDATA%\\axiom\n    const appData = process.env.APPDATA;\n    if (appData) {\n      return path.join(appData, CONFIG_DIR_NAME);\n    }\n    // Fallback to home directory if APPDATA is not set\n    return path.join(homeDir, 'AppData', 'Roaming', CONFIG_DIR_NAME);\n  }\n\n  return path.join(homeDir, '.config', CONFIG_DIR_NAME);\n}\n\n/**\n * Gets the full path to the config file.\n */\nexport function getGlobalConfigPath(): string {\n  return path.join(getConfigDir(), CONFIG_FILENAME);\n}\n\nexport async function loadGlobalConfig(): Promise<Config> {\n  const configPath = getGlobalConfigPath();\n  try {\n    const content = await fs.readFile(configPath, 'utf-8');\n    return JSON.parse(content);\n  } catch (error) {\n    if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n      return { profiles: {} };\n    }\n    throw error;\n  }\n}\n\nexport async function saveGlobalConfig(config: Config): Promise<void> {\n  const configPath = getGlobalConfigPath();\n  const configDir = path.dirname(configPath);\n  const content = JSON.stringify(config, null, 2);\n\n  // Ensure config directory exists\n  await fs.mkdir(configDir, { recursive: true, mode: 0o700 });\n\n  // Write config file\n  await fs.writeFile(configPath, content, 'utf-8');\n\n  // Set restrictive permissions (read/write for owner only)\n  // Note: chmod is a no-op on Windows, but that's fine\n  await fs.chmod(configPath, 0o600);\n}\n\nexport function getActiveProfile(config: Config): Profile | null {\n  // Get from config\n  const profileName = config.active_profile;\n  if (!profileName) return null;\n\n  const profile = config.profiles[profileName];\n  if (!profile) return null;\n\n  return profile;\n}\n","import type { TracerProvider } from '@opentelemetry/api';\nimport { type z } from 'zod';\nimport { AxiomCLIError } from '../util/errors';\nimport { getAuthContext } from '../cli/auth';\n\n/**\n * Utility type to make all properties in T required recursively.\n * Keeps the types as-is but removes the optionality.\n */\ntype DeepRequired<T> =\n  T extends Array<infer U>\n    ? Array<U>\n    : T extends (...args: any[]) => any\n      ? T\n      : T extends object\n        ? {\n            [P in keyof T]-?: DeepRequired<T[P]>;\n          }\n        : T;\n\n/**\n * Axiom API connection configuration\n */\nexport interface AxiomConnectionConfig {\n  /**\n   * Axiom API URL\n   * @default 'https://api.axiom.co'\n   * @example 'https://api.axiom.co'\n   */\n  url?: string;\n\n  /**\n   * Axiom API token (can be undefined if not set)\n   * @example process.env.AXIOM_TOKEN\n   */\n  token?: string | undefined;\n\n  /**\n   * Axiom dataset name\n   * @example process.env.AXIOM_DATASET\n   */\n  dataset?: string;\n\n  /**\n   * Axiom organization ID\n   * @example process.env.AXIOM_ORG_ID\n   */\n  orgId?: string;\n}\n\n/**\n * Options passed to the instrumentation hook\n * - url: string\n * - token: string\n * - dataset: string\n */\nexport interface AxiomEvalInstrumentationOptions {\n  url: string;\n  token: string;\n  dataset: string;\n  orgId?: string;\n}\n\n/**\n * Result returned from the instrumentation hook\n */\nexport interface AxiomEvalInstrumentationResult {\n  /**\n   * TracerProvider to be flushed when eval finishes.\n   *\n   * If you use the NodeSDK or register your provider globally, you don't need to return it\n   * here as the NodeSDK automatically flushes the global provider.\n   *\n   * Only return a provider if you want Axiom to explicitly flush it for you and it's not\n   * registered as the global tracer provider.\n   */\n  provider?: TracerProvider;\n}\n\nexport type SyncAxiomEvalInstrumentationHook = (\n  options: AxiomEvalInstrumentationOptions,\n) => AxiomEvalInstrumentationResult;\n\nexport type AsyncAxiomEvalInstrumentationHook = (\n  options: AxiomEvalInstrumentationOptions,\n) => Promise<AxiomEvalInstrumentationResult>;\n\n/**\n * Hook function to initialize application OpenTelemetry instrumentation.\n * Called before eval execution with resolved Axiom connection details.\n *\n * @param options - Configuration options\n * @param options.url - Axiom API URL\n * @param options.token - Axiom API token\n * @param options.dataset - Axiom dataset name\n * @returns TracerProvider or Promise resolving to TracerProvider\n *\n * @example\n * ```typescript\n * instrumentation: ({ url, token, dataset }) => {\n *   return setupAppInstrumentation({ url, token, dataset });\n * }\n * ```\n */\nexport type AxiomEvalInstrumentationHook = (\n  options: AxiomEvalInstrumentationOptions,\n) => AxiomEvalInstrumentationResult | Promise<AxiomEvalInstrumentationResult>;\n\n/**\n * Axiom AI SDK base configuration (user-facing, all optional)\n */\nexport const DEFAULT_EVAL_INCLUDE = ['**/*.eval.{ts,js,mts,mjs,cts,cjs}'] as const;\n\nexport interface AxiomConfigBase {\n  /**\n   * Eval configuration settings\n   *\n   * @example\n   * ```typescript\n   * eval: {\n   *   url: process.env.AXIOM_URL,\n   *   token: process.env.AXIOM_TOKEN,\n   *   dataset: process.env.AXIOM_DATASET\n   * }\n   * ```\n   */\n  eval?: AxiomConnectionConfig & {\n    /**\n     * Zod schema for flag validation.\n     * When provided, CLI flags (--flag.*) are validated against this schema\n     * before eval execution begins.\n     *\n     * @example\n     * ```typescript\n     * import { z } from 'zod';\n     *\n     * export default defineConfig({\n     *   eval: {\n     *     flagSchema: z.object({\n     *       model: z.object({\n     *         temperature: z.number().min(0).max(2).default(0.7),\n     *         name: z.string().default('gpt-4o'),\n     *       }),\n     *     }),\n     *   }\n     * });\n     * ```\n     */\n    flagSchema?: z.ZodObject<any> | null;\n    /**\n     * Optional hook to initialize application OpenTelemetry instrumentation.\n     * Called before eval execution with resolved Axiom connection details.\n     * Return your configured tracer provider/tracer (or void) after registering them.\n     */\n    instrumentation?: AxiomEvalInstrumentationHook | null;\n    /**\n     * Timeout for eval execution in milliseconds\n     * @default 60000\n     */\n    timeoutMs?: number;\n    /**\n     * Glob patterns to include when running evals\n     * @default ['**\\/*.eval.{ts,js,mts,mjs,cts,cjs}']\n     * @example ['**\\/*.eval.ts', 'tests/**\\/*.test.ts']\n     */\n    include?: string[];\n    /**\n     * Glob patterns to exclude when running evals\n     * @default ['**\\/node_modules/**', '**\\/dist/**', '**\\/build/**']\n     * @example ['**\\/node_modules/**', '**\\/.next/**']\n     */\n    exclude?: string[];\n  };\n}\n\n/**\n * Resolved Axiom AI SDK configuration with all required keys.\n * This is the type returned after merging user config with defaults.\n *\n * Uses DeepRequired to ensure all optional properties from AxiomConfigBase\n * become required, preventing missing properties in the resolved config.\n */\nexport type ResolvedAxiomConfig = DeepRequired<AxiomConfigBase>;\n\n/**\n * Axiom AI SDK configuration with optional environment-specific overrides.\n *\n * Supports c12 environment overrides using $development, $production, etc.\n *\n * @example\n * ```typescript\n * export default defineConfig({\n *   eval: {\n *     url: process.env.AXIOM_URL,\n *     token: process.env.AXIOM_TOKEN,\n *     dataset: process.env.AXIOM_DATASET,\n *   },\n * })\n * ```\n */\nexport interface AxiomConfig extends AxiomConfigBase {\n  /**\n   * Allow c12 environment-specific overrides ($development, $production, $test etc.)\n   * but don't show them in autocomplete for now\n   */\n  [key: `$${string}`]: Partial<AxiomConfigBase> | undefined;\n}\n\n/**\n * Type-safe helper for defining Axiom configuration.\n *\n * @param config - The configuration object\n * @returns The same configuration object with type checking\n *\n * @example\n * ```typescript\n * import { defineConfig } from 'axiom/ai/config';\n *\n * export default defineConfig({\n *   eval: {\n *     url: process.env.AXIOM_URL,\n *     token: process.env.AXIOM_TOKEN,\n *     dataset: process.env.AXIOM_DATASET,\n *     include: ['**\\/*.eval.{ts,js}'],\n *     instrumentation: ({ url, token, dataset }) => setupAppInstrumentation({ url, token, dataset }),\n *   },\n * });\n * ```\n */\nexport function defineConfig(config: AxiomConfig): AxiomConfig {\n  return config;\n}\n\n/**\n * Create partial default configuration from auth context or environment variables.\n * Does not throw if required values are missing - validation happens after merge.\n *\n * @returns Partial configuration with defaults and auth/env var values\n * @internal\n */\nexport function createPartialDefaults(): Partial<AxiomConfigBase> {\n  // Try to get auth context first (available when running via CLI)\n  // Fall back to process.env for backward compatibility (e.g., when used outside CLI)\n  let token: string | undefined;\n  let url: string | undefined;\n  let orgId: string | undefined;\n\n  try {\n    const authContext = getAuthContext();\n    if (authContext) {\n      token = authContext.token;\n      url = authContext.url;\n      orgId = authContext.orgId;\n    }\n  } catch {\n    // Auth context not available, fall back to env vars\n  }\n\n  // Fall back to process.env if auth context not available\n  token = token || process.env.AXIOM_TOKEN;\n  url = url || process.env.AXIOM_URL;\n  orgId = orgId || process.env.AXIOM_ORG_ID;\n\n  return {\n    eval: {\n      url: url || 'https://api.axiom.co',\n      orgId,\n      token,\n      dataset: process.env.AXIOM_DATASET,\n      flagSchema: undefined,\n      instrumentation: null,\n      include: [...DEFAULT_EVAL_INCLUDE],\n      exclude: [],\n      timeoutMs: 60_000,\n    },\n  };\n}\n\n/**\n * Validates and returns a fully resolved Axiom configuration.\n *\n * @param config - Partial configuration to validate\n * @returns Fully resolved configuration with all required fields\n * @throws {AxiomCLIError} If required fields are missing or invalid\n * @internal\n */\nexport function validateConfig(config: Partial<AxiomConfigBase>): ResolvedAxiomConfig {\n  const errors: string[] = [];\n  const isDebug = process.env.AXIOM_DEBUG === 'true';\n\n  if (!isDebug) {\n    if (!config.eval?.token) {\n      errors.push(\n        'eval.token is required (set in axiom.config.ts or AXIOM_TOKEN environment variable)',\n      );\n    }\n    if (!config.eval?.dataset) {\n      errors.push(\n        'eval.dataset is required (set in axiom.config.ts or AXIOM_DATASET environment variable)',\n      );\n    }\n\n    if (!config.eval?.url) {\n      console.log(\n        'eval.url was not specified. Defaulting to `https://api.axiom.co`. Please set it in axiom.config.ts or AXIOM_URL environment variable if you want to use a different endpoint.',\n      );\n    }\n  }\n\n  const instrumentation = config.eval?.instrumentation;\n  if (\n    instrumentation !== null &&\n    instrumentation !== undefined &&\n    typeof instrumentation !== 'function'\n  ) {\n    errors.push(\n      'eval.instrumentation must be a function returning OTEL setup information or null.',\n    );\n  }\n\n  if (errors.length > 0) {\n    throw new AxiomCLIError(`Invalid Axiom configuration:\\n  - ${errors.join('\\n  - ')}`);\n  }\n\n  return config as ResolvedAxiomConfig;\n}\n","export * from './types';\nexport * from './config';\nexport * from './oauth';\nexport * from './api';\nexport * from './callback-server';\nexport * from './global-auth';\n","export interface Profile {\n  url: string;\n  token: string;\n  org_id: string;\n}\n\nexport interface Config {\n  active_profile?: string;\n  profiles: Record<string, Profile>;\n}\n\nexport interface OAuthTokenResponse {\n  access_token: string;\n  token_type: string;\n  expires_in?: number;\n  refresh_token?: string;\n  scope?: string;\n}\n\nexport interface Organization {\n  id: string;\n  name: string;\n  slug?: string;\n}\n","import { randomBytes, createHash } from 'crypto';\nimport type { OAuthTokenResponse } from './types';\n\nconst OAUTH_CLIENT_ID = '264d906a404efc209b027f6595e6b616';\nconst OAUTH_AUTH_PATH = '/oauth/authorize';\nconst OAUTH_TOKEN_PATH = '/oauth/token';\n\nexport interface BuildAuthUrlParams {\n  redirectUri: string;\n  state: string;\n  codeChallenge: string;\n}\n\nexport interface ExchangeCodeParams {\n  code: string;\n  redirectUri: string;\n  codeVerifier: string;\n}\n\nexport class OAuth {\n  constructor(private readonly oauthBaseUrl: string) {}\n\n  static generateCodeVerifier(): string {\n    return randomBytes(32).toString('base64url');\n  }\n\n  static generateCodeChallenge(verifier: string): string {\n    return createHash('sha256').update(verifier).digest('base64url');\n  }\n\n  static generateState(): string {\n    return randomBytes(16).toString('hex');\n  }\n\n  public buildAuthUrl(params: BuildAuthUrlParams): string {\n    const url = new URL(OAUTH_AUTH_PATH, this.oauthBaseUrl);\n    url.searchParams.set('client_id', OAUTH_CLIENT_ID);\n    url.searchParams.set('redirect_uri', params.redirectUri);\n    url.searchParams.set('response_type', 'code');\n    url.searchParams.set('state', params.state);\n    url.searchParams.set('code_challenge', params.codeChallenge);\n    url.searchParams.set('code_challenge_method', 'S256');\n    url.searchParams.set('scope', '*');\n    return url.toString();\n  }\n\n  public async exchangeCodeForToken(params: ExchangeCodeParams): Promise<string> {\n    const tokenUrl = new URL(OAUTH_TOKEN_PATH, this.oauthBaseUrl);\n\n    const body = new URLSearchParams({\n      grant_type: 'authorization_code',\n      client_id: OAUTH_CLIENT_ID,\n      code: params.code,\n      redirect_uri: params.redirectUri,\n      code_verifier: params.codeVerifier,\n    });\n\n    const response = await fetch(tokenUrl.toString(), {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded',\n      },\n      body: body.toString(),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Token exchange failed: ${response.status} ${errorText}`);\n    }\n\n    const data: OAuthTokenResponse = await response.json();\n    return data.access_token;\n  }\n}\n","import { AxiomCLIError } from '../../util/errors';\nimport type { Organization } from './types';\n\nexport async function fetchOrganizations(\n  token: string,\n  apiBaseUrl: string,\n): Promise<Organization[]> {\n  const response = await fetch(`${apiBaseUrl}/v2/orgs`, {\n    headers: {\n      Authorization: `Bearer ${token}`,\n      'Content-Type': 'application/json',\n    },\n  });\n\n  if (!response.ok) {\n    throw new AxiomCLIError(\n      `Failed to fetch organizations: ${response.status} ${response.statusText}`,\n    );\n  }\n\n  const data = await response.json();\n  return data as Organization[];\n}\n\nexport async function verifyToken(\n  token: string,\n  orgId: string,\n  apiBaseUrl: string,\n): Promise<boolean> {\n  const response = await fetch(`${apiBaseUrl}/v2/user`, {\n    headers: {\n      Authorization: `Bearer ${token}`,\n      'X-Axiom-Org-Id': orgId,\n      'Content-Type': 'application/json',\n    },\n  });\n\n  return response.ok;\n}\n","import http, { type IncomingMessage, type ServerResponse } from 'http';\nimport type { AddressInfo } from 'net';\n\nfunction escapeHtml(text: string): string {\n  const map: Record<string, string> = {\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#039;',\n    '`': '&#96;',\n  };\n  return text.replace(/[&<>\"']/g, (m) => map[m] || m);\n}\n\nconst SVG_LOGO = `<svg width=\"124\" height=\"24\" viewBox=\"0 0 124 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" class=\"logo\">\n<path d=\"M42.9919 16.8116H36.3696L35.5537 19.1572C35.4209 19.539 34.9714 19.8513 34.5548 19.8513H30.9779C30.5614 19.8513 30.3459 19.5449 30.499 19.1703L36.9816 3.31644C37.1346 2.9419 37.6009 2.63546 38.0174 2.63546H41.3718C41.7883 2.63546 42.2541 2.94207 42.4067 3.3168L48.8634 19.17C49.016 19.5447 48.8 19.8513 48.3835 19.8513H44.8067C44.3901 19.8513 43.9406 19.539 43.8078 19.1572L42.9919 16.8116ZM41.8232 13.4223L39.6807 7.18148L37.5383 13.4223H41.8232ZM64.1105 19.8513C63.694 19.8513 63.1767 19.5694 62.9611 19.2247L59.9029 14.3369L56.8447 19.2247C56.6291 19.5694 56.1119 19.8513 55.6953 19.8513H51.3392C50.9227 19.8513 50.7754 19.5801 51.0119 19.2486L56.8978 11.0013L51.5315 3.24414C51.2999 2.90937 51.4513 2.63546 51.8679 2.63546H55.89C56.3066 2.63546 56.8268 2.91563 57.0461 3.25807L59.9029 7.71959L62.7343 3.25955C62.9522 2.9163 63.4713 2.63546 63.8879 2.63546H67.938C68.3545 2.63546 68.5048 2.90868 68.272 3.24261L62.8801 10.9743L68.7935 19.2489C69.0303 19.5802 68.8832 19.8513 68.4666 19.8513H64.1105ZM76.525 19.119C76.525 19.5218 76.1841 19.8513 75.7675 19.8513H72.5522C72.1356 19.8513 71.7947 19.5218 71.7947 19.119V3.36771C71.7947 2.96498 72.1356 2.63546 72.5522 2.63546H75.7675C76.1841 2.63546 76.525 2.96498 76.525 3.36771V19.119ZM79.3736 11.1896C79.3736 6.18625 83.2688 2.15134 89.2511 2.15134C95.2334 2.15134 99.1289 6.18625 99.1289 11.1896C99.1289 16.2199 95.2334 20.2548 89.2511 20.2548C83.2688 20.2548 79.3736 16.2199 79.3736 11.1896ZM94.2873 11.1896C94.2873 8.58038 92.3953 6.21307 89.2511 6.21307C86.1349 6.21307 84.2149 8.58038 84.2149 11.1896C84.2149 13.7989 86.1349 16.2199 89.2511 16.2199C92.3675 16.2199 94.2873 13.7989 94.2873 11.1896ZM119.318 19.8513C118.902 19.8513 118.517 19.5245 118.463 19.1251L117.225 9.89847L113.65 19.1652C113.505 19.5426 113.045 19.8513 112.628 19.8513H111.055C110.638 19.8513 110.179 19.5423 110.034 19.1645L106.457 9.81766L105.218 19.125C105.165 19.5245 104.781 19.8513 104.364 19.8513H101.344C100.927 19.8513 100.633 19.5249 100.69 19.1259L102.932 3.3609C102.988 2.96191 103.376 2.63546 103.792 2.63546H106.59C107.007 2.63546 107.469 2.94351 107.617 3.32002L111.827 14.041L116.064 3.31949C116.213 2.94327 116.676 2.63546 117.092 2.63546H119.89C120.307 2.63546 120.694 2.96191 120.751 3.3609L122.993 19.1259C123.05 19.5249 122.755 19.8513 122.339 19.8513H119.318ZM23.9616 15.6531L18.8054 6.97021C18.5689 6.57115 17.9863 6.24465 17.5106 6.24465H14.2915C13.5433 6.24465 13.2365 5.73171 13.6097 5.1048L15.375 2.13986C15.5151 1.90455 15.5148 1.61487 15.3743 1.37981C15.2337 1.14476 14.9741 1 14.6933 1H10.2025C9.72681 1 9.14291 1.32577 8.90491 1.72395L0.17865 16.3217C-0.0594434 16.7199 -0.0595348 17.3715 0.178285 17.7698L2.42362 21.5297C2.79777 22.1561 3.41129 22.1569 3.78699 21.5313L5.54143 18.6103C5.91722 17.9847 6.53065 17.9854 6.9048 18.6119L8.49538 21.2754C8.7332 21.6737 9.317 21.9995 9.79273 21.9995H20.1698C20.6455 21.9995 21.2293 21.6737 21.4672 21.2754L23.959 17.1028C24.1968 16.7045 24.198 16.0521 23.9616 15.6531ZM16.9981 15.2352C17.3699 15.8629 17.0619 16.3765 16.3136 16.3765H8.24192C7.49372 16.3765 7.1876 15.864 7.56175 15.2375L11.6007 8.47417C11.9748 7.84772 12.5869 7.84774 12.9611 8.47421L16.9981 15.2352Z\" fill=\"#121224\"/>\n</svg>`;\n\nfunction renderCallbackPage(error?: string): string {\n  const errorClass = error ? ' class=\"error\"' : '';\n  const errorMessage = error ? escapeHtml(error) : '';\n\n  return `<!doctype html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"utf-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <title>Axiom</title>\n    <link rel=\"icon\" href=\"https://app.axiom.co/static/favicon.ico\">\n    <meta name=\"description\" content=\"Axiom CLI\">\n    <meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n    <style>\n        html,\n        body,\n        .root {\n            width: 100%;\n            height: 100%;\n            text-rendering: optimizeLegibility;\n            -webkit-font-smoothing: antialiased;\n        }\n        body {\n            color: #334155;\n            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif, Apple Color Emoji, Segoe UI Emoji;\n            font-size: 14px;\n            font-weight: 500;\n            font-variant: tabular-nums;\n            line-height: 1.5;\n            background-color: #fff;\n            font-feature-settings: \"tnum\";\n            margin: 0;\n        }\n        h1,\n        h2,\n        h3,\n        h4,\n        h5,\n        h6 {\n            margin-top: 0;\n            margin-bottom: .5em;\n            font-weight: 500;\n        }\n        p {\n            margin-top: 0;\n            margin-bottom: 1em;\n        }\n        h2 {\n            font-size: 16px;\n            font-weight: 600;\n        }\n        .root {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .logo {\n            width: 92px;\n            float: left;\n            position: absolute;\n            top: 16px;\n            left: 16px;\n        }\n        .center p {\n            padding: 8px 0;\n        }\n        .error .center {\n            color: #bf0e08;\n        }\n    </style>\n</head>\n<body${errorClass}>\n    <div class=\"root\">\n        <a class=\"\" target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://axiom.co\">\n          ${SVG_LOGO}\n        </svg>\n        </a>\n        <div class=\"center\">\n            ${\n              error\n                ? `<h2 id=\"msg\">Login failed</h2>\n            <p id=\"details\">${errorMessage}</p>`\n                : `<h2 id=\"msg\">Login successful</h2>\n            <p id=\"details\">You can close this page and return to your CLI.</p>`\n            }\n        </div>\n    </div>\n    <script>\n        window.history.replaceState({}, '', \\`\\${window.location.pathname}\\`);\n    </script>\n</body>\n</html>`;\n}\n\nexport interface CallbackServerResult {\n  server: http.Server;\n  port: number;\n  url: string;\n}\n\nexport async function startCallbackServer(): Promise<CallbackServerResult> {\n  return new Promise((resolve) => {\n    const server = http.createServer();\n    server.listen(0, '127.0.0.1', () => {\n      const address = server.address() as AddressInfo;\n      resolve({\n        server,\n        port: address.port,\n        url: `http://127.0.0.1:${address.port}`,\n      });\n    });\n  });\n}\n\nexport interface CallbackResult {\n  code: string;\n}\n\nexport async function waitForCallback(\n  server: http.Server,\n  expectedState: string,\n): Promise<CallbackResult> {\n  return new Promise((resolve, reject) => {\n    const timeout = setTimeout(\n      () => {\n        server.close();\n        reject(new Error('Authentication timeout after 5 minutes'));\n      },\n      5 * 60 * 1000,\n    ); // 5 minute timeout\n\n    server.on('request', (req: IncomingMessage, res: ServerResponse) => {\n      const url = new URL(req.url || '', `http://${req.headers.host}`);\n      const code = url.searchParams.get('code');\n      const state = url.searchParams.get('state');\n      const error = url.searchParams.get('error');\n      const errorDescription = url.searchParams.get('error_description');\n\n      if (error) {\n        const errorMsg = errorDescription || error;\n        res.writeHead(400, { 'Content-Type': 'text/html' });\n        res.end(renderCallbackPage(errorMsg));\n        clearTimeout(timeout);\n        server.close();\n        reject(new Error(`OAuth error: ${errorMsg}`));\n        return;\n      }\n\n      if (!code || !state) {\n        res.writeHead(400, { 'Content-Type': 'text/html' });\n        res.end(renderCallbackPage('Missing code or state parameter'));\n        return;\n      }\n\n      if (state !== expectedState) {\n        res.writeHead(400, { 'Content-Type': 'text/html' });\n        res.end(renderCallbackPage('Invalid state parameter (CSRF protection)'));\n        clearTimeout(timeout);\n        server.close();\n        reject(new Error('Invalid state parameter'));\n        return;\n      }\n\n      res.writeHead(200, { 'Content-Type': 'text/html' });\n      res.end(renderCallbackPage());\n\n      clearTimeout(timeout);\n      server.close();\n      resolve({ code });\n    });\n  });\n}\n"],"mappings":"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","names":["authContext"]}