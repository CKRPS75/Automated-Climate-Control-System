{"version":3,"sources":["../../src/evals/custom-runner.ts"],"sourcesContent":["import { VitestTestRunner } from 'vitest/runners';\nimport { existsSync, readFileSync, writeFileSync } from 'node:fs';\nimport { validateName } from './name-validation-runtime';\n\n/**\n * Custom Vitest runner that validates eval and scorer names before running any tests.\n *\n * The default runner doesn't give us a good way of doing this validation\n * before tests start, unfortunately.\n */\nexport default class AxiomEvalRunner extends VitestTestRunner {\n  private validationChecked = false;\n\n  /**\n   * Override onBeforeRunSuite to validate names before the first suite runs.\n   */\n  async onBeforeRunSuite(suite: any): Promise<void> {\n    if (!this.validationChecked) {\n      this.validationChecked = true;\n\n      const registryFile = process.env.AXIOM_NAME_REGISTRY_FILE;\n      const abortFile = process.env.AXIOM_ABORT_FILE;\n\n      // Validate all names from the registry file\n      if (registryFile && abortFile && existsSync(registryFile)) {\n        const errors: string[] = [];\n        const content = readFileSync(registryFile, 'utf8');\n        const lines = content.trim().split('\\n').filter(Boolean);\n        const seenEvals = new Set<string>();\n        const seenScorers = new Set<string>();\n\n        for (const line of lines) {\n          try {\n            const record = JSON.parse(line) as { kind: 'eval' | 'scorer'; name: string };\n            const seen = record.kind === 'eval' ? seenEvals : seenScorers;\n            if (seen.has(record.name)) continue;\n            seen.add(record.name);\n\n            try {\n              validateName(record.name, record.kind);\n            } catch (error) {\n              errors.push((error as Error).message);\n            }\n          } catch {\n            // Skip malformed lines\n          }\n        }\n\n        if (errors.length > 0) {\n          const message = [\n            'Validation failed. No tests will run due to the following errors:',\n            '',\n            ...errors,\n            '',\n          ].join('\\n');\n\n          writeFileSync(abortFile, message, 'utf8');\n          throw new Error('\\n' + message + '\\n');\n        }\n      }\n    }\n\n    await super.onBeforeRunSuite(suite);\n  }\n}\n"],"mappings":";;;;;;;;;;;AAAA;AAAA,SAAS,wBAAwB;AACjC,SAAS,YAAY,cAAc,qBAAqB;AASxD,IAAqB,kBAArB,cAA6C,iBAAiB;AAAA,EAA9D;AAAA;AACE,wBAAQ,qBAAoB;AAAA;AAAA;AAAA;AAAA;AAAA,EAK5B,MAAM,iBAAiB,OAA2B;AAChD,QAAI,CAAC,KAAK,mBAAmB;AAC3B,WAAK,oBAAoB;AAEzB,YAAM,eAAe,QAAQ,IAAI;AACjC,YAAM,YAAY,QAAQ,IAAI;AAG9B,UAAI,gBAAgB,aAAa,WAAW,YAAY,GAAG;AACzD,cAAM,SAAmB,CAAC;AAC1B,cAAM,UAAU,aAAa,cAAc,MAAM;AACjD,cAAM,QAAQ,QAAQ,KAAK,EAAE,MAAM,IAAI,EAAE,OAAO,OAAO;AACvD,cAAM,YAAY,oBAAI,IAAY;AAClC,cAAM,cAAc,oBAAI,IAAY;AAEpC,mBAAW,QAAQ,OAAO;AACxB,cAAI;AACF,kBAAM,SAAS,KAAK,MAAM,IAAI;AAC9B,kBAAM,OAAO,OAAO,SAAS,SAAS,YAAY;AAClD,gBAAI,KAAK,IAAI,OAAO,IAAI,EAAG;AAC3B,iBAAK,IAAI,OAAO,IAAI;AAEpB,gBAAI;AACF,2BAAa,OAAO,MAAM,OAAO,IAAI;AAAA,YACvC,SAAS,OAAO;AACd,qBAAO,KAAM,MAAgB,OAAO;AAAA,YACtC;AAAA,UACF,QAAQ;AAAA,UAER;AAAA,QACF;AAEA,YAAI,OAAO,SAAS,GAAG;AACrB,gBAAM,UAAU;AAAA,YACd;AAAA,YACA;AAAA,YACA,GAAG;AAAA,YACH;AAAA,UACF,EAAE,KAAK,IAAI;AAEX,wBAAc,WAAW,SAAS,MAAM;AACxC,gBAAM,IAAI,MAAM,OAAO,UAAU,IAAI;AAAA,QACvC;AAAA,MACF;AAAA,IACF;AAEA,UAAM,MAAM,iBAAiB,KAAK;AAAA,EACpC;AACF;","names":[]}